<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
<title>RabbitMQ å…¥é—¨æ•™ç¨‹ï¼ˆäºŒï¼‰- å·¥ä½œé˜Ÿåˆ— - Haotrr</title>
<meta name="description" content="A beautiful world you deserve.">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link type='text/css' rel='stylesheet' href='https://haottr.github.io/styles/main.css' media='screen' />
<link type="text/css" rel="stylesheet" href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css">
<link type="text/css" rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">

<script type="text/javascript" src='https://haottr.github.io/media/scripts/jquery.js'></script>
<script type="text/javascript" src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/go.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>
</head>

<body>
  <div class="layout">
    <div class="layout-header">

	<div class="layout-header-main">
		<div class="container">
			<div class="row justify-content-lg-center">
				<div class="col-12 col-lg-9">

					<div class="navbar">

						<div class="logo">
							<a href="https://haottr.github.io">
								<img class="logo"
									src="https://haottr.github.io/media/images/site_avatar.png?v=1591854930679"
									alt="">
							</a>
						</div>

						<div class="menu d-md-inline-block d-none">
							<ul class="layout-navigation-list">
								
								<li class="layout-navigation-item"><a title="é¦–é¡µ"
										href="/">é¦–é¡µ</a>
								</li>
								
								<li class="layout-navigation-item"><a title="æ¦œå•"
										href="/post/the-best-of-the-best">æ¦œå•</a>
								</li>
								
								<li class="layout-navigation-item"><a title="å½’æ¡£"
										href="/archives">å½’æ¡£</a>
								</li>
								
								<li class="layout-navigation-item"><a title="æ ‡ç­¾"
										href="/tags">æ ‡ç­¾</a>
								</li>
								
								<li class="layout-navigation-item"><a title="å…³äº"
										href="/post/about">å…³äº</a>
								</li>
								
							</ul>
						</div>

						<div class="item d-md-inline-block d-none" id="theme-dark-search">
							<div class="search-icon">
								<i class="fa fa-search" aria-hidden="true"></i>
							</div>
						</div>



						<div class="d-md-inline-block d-none">
							<div class="search-lightbox">
								<div class="search-body">

									<form id="gridea-search-form" data-update="1591854930679" action="/search/"
										class="search-form">
										<input type="text" name="q" id="s" value="" class="search-field"
											placeholder="è¯·è¾“å…¥æœç´¢å…³é”®è¯" aria-label="è¯·è¾“å…¥æœç´¢å…³é”®è¯" required="">
										<button type="submit" class="submit" aria-label="Submit">
											<i class="fa fa-search" aria-hidden="true"></i>
										</button>
									</form>

								</div>
							</div>
						</div>

						<div class="nav d-md-none d-inline-block">
							<div class="trigger">
								<i class="fa fa-bars layout-btn-toggle" aria-hidden="true"></i>
							</div>
						</div>

						<div class="theme-toggle">
							<i class="fa" id="theme-style" aria-hidden="true"></i>
						</div>

					</div>

				</div>
			</div>




		</div>
	</div>

</div>
    <div class="layout-collapse d-md-none">
	<div class="layout-collapse-main">
		<ul class="layout-collapse-list">
			
			<li class="layout-collapse-item"><a title="é¦–é¡µ" href="/">é¦–é¡µ</a></li>
			
			<li class="layout-collapse-item"><a title="æ¦œå•" href="/post/the-best-of-the-best">æ¦œå•</a></li>
			
			<li class="layout-collapse-item"><a title="å½’æ¡£" href="/archives">å½’æ¡£</a></li>
			
			<li class="layout-collapse-item"><a title="æ ‡ç­¾" href="/tags">æ ‡ç­¾</a></li>
			
			<li class="layout-collapse-item"><a title="å…³äº" href="/post/about">å…³äº</a></li>
			

		</ul>
	</div>
</div>

    <div class="layout-content">
      <div class="layout-content-main">
        <div class="container">
          <div class="row justify-content-lg-center">
            <div class="col-12 col-lg-9">
              <div class="layout-post">
                <div class="layout-post-body">
                  <div class="row">

                    <div class="col-12 col-lg-9">
                      <div class="layout-post-main m-right m-md-right">
                        <div class="layout-post-header">
                          <h1 class="layout-post-title">RabbitMQ å…¥é—¨æ•™ç¨‹ï¼ˆäºŒï¼‰- å·¥ä½œé˜Ÿåˆ—</h1>
                          <div class="layout-post-meta">
                            <div class="item">
                               <a href="https://haottr.github.io/tag/rabbitmq/" class="post--keyword"
                                data-title="RabbitMQ" data-type="post_tag" data-term-id="39">RabbitMQ</a>
                               <a href="https://haottr.github.io/tag/go/" class="post--keyword"
                                data-title="Go" data-type="post_tag" data-term-id="39">Go</a>
                              
                            </div>
                            <div class="item">
                              <span>2018-09-29</span>
                            </div>
                          </div>
                        </div>
                        <div class="layout-post-content">
                          <div class="layout-post-item">
                            <!-- 
                            <p class="with-img"><img src="http://img-haotrr.test.upcdn.net/blog/Greece2.jpg"
                                class="attachment-full size-full wp-post-image" alt="RabbitMQ å…¥é—¨æ•™ç¨‹ï¼ˆäºŒï¼‰- å·¥ä½œé˜Ÿåˆ—" /></p>
                             -->
                            <p>æœ¬ç³»åˆ—æ˜¯ RabbitMQ å®˜æ–¹æ•™ç¨‹ Go ç‰ˆæœ¬çš„ä¸­è¯‘ç‰ˆæœ¬ï¼Œæœ¬æ–‡ä¸ºç¬¬äºŒç¯‡ï¼Œä»‹ç»å¦‚ä½•å°† RabbitMQ ä½œä¸ºå·¥ä½œé˜Ÿåˆ—ä½¿ç”¨ã€‚</p>
<!-- more -->
<p><a href="http://www.rabbitmq.com/tutorial-two-go.html">æ•™ç¨‹äºŒ åŸæ–‡åœ°å€: &quot;Work Queues&quot;</a></p>
<p>åœ¨ <a href="/post/rabbitmq-tutorial-go-1/">æ•™ç¨‹ä¸€</a> ä¸­æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªä»å‘½åçš„é˜Ÿåˆ—ä¸­å‘é€å’Œè¯»å–æ¶ˆæ¯çš„ç¨‹åºï¼Œåœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç”¨äºåˆ†å‘è¢«å¤šä¸ªå·¥ä½œè€…ï¼ˆworkerï¼‰å®æ—¶æ¶ˆè´¹çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆWork Queueï¼‰ã€‚</p>
<p>å·¥ä½œé˜Ÿåˆ—ï¼ˆåˆåä»»åŠ¡é˜Ÿåˆ—ï¼‰èƒŒåçš„ä¸»è¦æ€æƒ³æ˜¯ï¼šé¿å…ç«‹å³å¤„ç†ä¸€ä¸ªèµ„æºé›†ä¸­å‹çš„ä»»åŠ¡å¹¶ç­‰åˆ°å®ƒå®Œæˆä¸ºæ­¢ï¼Œè€Œæ˜¯å°†å…¶å»¶åå¤„ç†ã€‚æˆ‘ä»¬å°†ä¸€ä¸ªæ¶ˆæ¯å°è£…æˆä¸€ä¸ªä»»åŠ¡ï¼ˆtaskï¼‰å¹¶å°†å…¶å‘é€åˆ°é˜Ÿåˆ—ä¸­ï¼Œä¸€ä¸ªåå°è¿è¡Œçš„å·¥ä½œçº¿ç¨‹ï¼ˆworker processï¼‰ä¼šä»é˜Ÿåˆ—å¤´éƒ¨ä¾æ¬¡å–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œç›¸å…³æ“ä½œã€‚å¦‚æœåŒæ—¶è¿è¡Œå¤šä¸ªå·¥ä½œçº¿ç¨‹ï¼Œåˆ™ä¸åŒçš„ä»»åŠ¡ä¼šè¢«åˆ†é…åˆ°ä¸åŒçš„å·¥ä½œçº¿ç¨‹ä¸­ã€‚</p>
<p>è¿™ä¸ªæ¦‚å¿µåœ¨é‚£äº›é€šè¿‡çŸ­è¿æ¥çš„ HTTP è¯·æ±‚å¤„ç†å¤æ‚ä»»åŠ¡çš„ Web åº”ç”¨ç¨‹åºä¸­å°¤å…¶æœ‰ç”¨ã€‚</p>
<h2 id="å‡†å¤‡">å‡†å¤‡</h2>
<p>åœ¨æœ¬ç³»åˆ—æ•™ç¨‹çš„æ•™ç¨‹ä¸€ä¸­ï¼Œæˆ‘ä»¬å‘é€äº†ä¸€ä¸ªåŒ…å«&quot;Hello World!&quot;çš„æ¶ˆæ¯ï¼Œç°åœ¨æˆ‘ä»¬å°†å‘é€ä»£è¡¨å¤æ‚ä»»åŠ¡çš„å­—ç¬¦ä¸²ã€‚æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰åƒå›¾ç‰‡å¤§å°è°ƒæ•´æˆ–æ¸²æŸ“ PDF æ–‡ä»¶è¿™æ ·çš„çœŸå®ä»»åŠ¡ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨ <code>time.Sleep</code> å‡½æ•°ä¼ªé€ ä»»åŠ¡æ¥å‡è£…å¾ˆå¿™ã€‚æˆ‘ä»¬ä½¿ç”¨å­—ç¬¦ä¸²ä¸­ç‚¹ï¼ˆdotï¼‰çš„ä¸ªæ•°æ¥è¡¨ç¤ºä»»åŠ¡çš„å¤æ‚ç¨‹åº¦ï¼Œæ¯ä¸€ä¸ªç‚¹å°†èŠ±è´¹å·¥ä½œè€…ä¸€ç§’é’Ÿçš„æ—¶é—´ï¼Œæ¯”å¦‚ï¼Œä¸€ä¸ªç”±å­—ç¬¦ä¸² <code>Hello...</code> ä¼ªé€ çš„ä»»åŠ¡å°†èŠ±è´¹ 3 ç§’é’Ÿçš„æ—¶é—´ã€‚</p>
<p>æˆ‘ä»¬å°†ç¨ç¨æ”¹é€ å‰ä¾‹ä¸­çš„ <code>send.go</code> æ–‡ä»¶ä¸­çš„ä»£ç ï¼Œä»è€Œè®©æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œæ¥å‘é€ä»»æ„å†…å®¹çš„æ¶ˆæ¯ã€‚è¿™ä¸ªç¨‹åºå°†ä»»åŠ¡è°ƒåº¦åˆ°æˆ‘ä»¬çš„å·¥ä½œé˜Ÿåˆ—ä¸­ï¼Œæˆ‘ä»¬å°†å…¶å‘½åä¸º <code>new_task.go</code> ï¼š</p>
<pre><code class="language-go">body := bodyFrom(os.Args)
err = ch.Publish(
  &quot;&quot;,           // exchange
  q.Name,       // routing key
  false,        // mandatory
  false,
  amqp.Publishing {
    DeliveryMode: amqp.Persistent,
    ContentType:  &quot;text/plain&quot;,
    Body:         []byte(body),
  })
failOnError(err, &quot;Failed to publish a message&quot;)
log.Printf(&quot; [x] Sent %s&quot;, body)
</code></pre>
<p>æ—§çš„ <code>receive.go</code> æ–‡ä»¶åŒæ ·éœ€è¦è°ƒæ•´ï¼šå®ƒéœ€è¦ä¼ªé€ ä»¥ç§’ä¸ºå•ä½å¤„ç†æ¶ˆæ¯ä¸­æ¯ä¸ªç‚¹çš„å·¥ä½œä»»åŠ¡ï¼Œå®ƒéœ€è¦ä»å·¥ä½œé˜Ÿåˆ—ä¸­ä¾æ¬¡å–å‡ºæ¶ˆæ¯å¹¶å¤„ç†ç›¸åº”çš„å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å…¶å‘½åä¸º <code>worker.go</code> ï¼š</p>
<pre><code class="language-go">msgs, err := ch.Consume(
  q.Name, // queue
  &quot;&quot;,     // consumer
  true,   // auto-ack
  false,  // exclusive
  false,  // no-local
  false,  // no-wait
  nil,    // args
)
failOnError(err, &quot;Failed to register a consumer&quot;)

forever := make(chan bool)

go func() {
  for d := range msgs {
    log.Printf(&quot;Received a message: %s&quot;, d.Body)
    dot_count := bytes.Count(d.Body, []byte(&quot;.&quot;))
    t := time.Duration(dot_count)
    time.Sleep(t * time.Second)
    log.Printf(&quot;Done&quot;)
  }
}()

log.Printf(&quot; [*] Waiting for messages. To exit press CTRL+C&quot;)
&lt;-forever
</code></pre>
<p>æ³¨æ„ï¼Œæˆ‘ä»¬çš„ä¼ªé€ ä»»åŠ¡æ¨¡æ‹Ÿäº†æ‰§è¡Œæ—¶é—´ã€‚</p>
<p>è¿è¡Œæ“ä½œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh"># shell 1
go run worker.go
</code></pre>
<pre><code class="language-sh"># shell 2
go run worker.go
</code></pre>
<h2 id="è½®è¯¢åˆ†å‘">è½®è¯¢åˆ†å‘</h2>
<p>ä»»åŠ¡é˜Ÿåˆ—çš„ä¼˜åŠ¿ä¹‹ä¸€æ˜¯å®ƒå¾ˆå®¹æ˜“åœ°å°†ä»»åŠ¡å¹³è¡Œåˆ†å‘ã€‚å‡è®¾æˆ‘ä»¬æ­£åœ¨å¤„ç†ä¸€ä¸ªå°†ç§¯å‹çš„å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°é€šè¿‡å¢åŠ æ›´å¤šçš„å·¥ä½œè€…ï¼ˆworkerï¼‰æ¥è§£å†³å®ƒï¼Œæ‰©å±•èµ·æ¥å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬åŒæ—¶è¿è¡Œä¸¤ä¸ª <code>work.go</code>ï¼Œå®ƒä»¬å°†åŒæ—¶ä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ï¼Œä½†å…·ä½“å¦‚ä½•è·å–å‘¢ï¼Ÿæˆ‘ä»¬æ‹­ç›®ä»¥å¾…ã€‚</p>
<p>ä½ éœ€è¦æ‰“å¼€ä¸‰ä¸ªç»ˆç«¯ï¼Œå…¶ä¸­ä¸¤ä¸ªè¿è¡Œ <code>worker.go</code>ï¼Œè¿™ä¸¤ä¸ªç»ˆç«¯å°†ä½œä¸ºæˆ‘ä»¬çš„æ¶ˆè´¹è€… -- ç”¨ C1 å’Œ C2 è¡¨ç¤ºã€‚</p>
<pre><code class="language-sh"># shell 1
go run worker.go
# =&gt; [*] Waiting for messages. To exit press CTRL+C
</code></pre>
<pre><code class="language-sh"># shell 2
go run worker.go
# =&gt; [*] Waiting for messages. To exit press CTRL+C
</code></pre>
<p>åœ¨ç¬¬ä¸‰ä¸ªç»ˆç«¯ä¸­ï¼Œæˆ‘ä»¬å‘å¸ƒæ–°çš„ä»»åŠ¡ã€‚ä¸€æ—¦ä½ è¿è¡Œäº†æ¶ˆè´¹è€…ä¹‹åï¼Œä½ å°±å¯ä»¥å‘é€ä¸€äº›æ¶ˆæ¯äº†ï¼š</p>
<pre><code class="language-sh"># shell 3
go run new_task.go First message.
go run new_task.go Second message..
go run new_task.go Third message...
go run new_task.go Fourth message....
go run new_task.go Fifth message.....
</code></pre>
<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹å‘é€åˆ°æ¶ˆè´¹è€…ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼š</p>
<pre><code class="language-sh"># shell 1
go run worker.go
# =&gt; [*] Waiting for messages. To exit press CTRL+C
# =&gt; [x] Received 'First message.'
# =&gt; [x] Received 'Third message...'
# =&gt; [x] Received 'Fifth message.....'
</code></pre>
<pre><code class="language-sh"># shell 2
go run worker.go
# =&gt; [*] Waiting for messages. To exit press CTRL+C
# =&gt; [x] Received 'Second message..'
# =&gt; [x] Received 'Fourth message....'
</code></pre>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒRabbitMQ å°†é¡ºåºçš„æŠŠæ¯ä¸ªæ¶ˆæ¯å‘é€ç»™ä¸‹ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚æ¯ä¸ªæ¶ˆè´¹è€…å°†å¹³å‡çš„è·å¾—ç›¸åŒæ•°ç›®çš„æ¶ˆæ¯ï¼Œè¿™ç§åˆ†å‘æ¶ˆæ¯çš„æœºåˆ¶å«åšè½®è¯¢åˆ†å‘ï¼ˆround-robinï¼‰ã€‚å¯ä»¥å°è¯•ä½¿ç”¨ä¸‰ä¸ªæˆ–æ›´å¤šçš„å·¥ä½œè€…æ¥éªŒè¯ä¸€ä¸‹ã€‚</p>
<h2 id="æ¶ˆæ¯ç¡®è®¤">æ¶ˆæ¯ç¡®è®¤</h2>
<p>å¤„ç†ä»»åŠ¡éœ€è¦èŠ±è´¹å‡ ç§’é’Ÿçš„æ—¶é—´ï¼Œä½ æˆ–è®¸å¯¹ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†ä¸€ä¸ªé•¿æ—¶é—´çš„ä»»åŠ¡ä½†åªå¤„ç†äº†ä¸€éƒ¨åˆ†æ—¶å°±ç»ˆæ­¢çš„æƒ…å†µä¼šæ€æ ·æ„Ÿåˆ°å¥½å¥‡ã€‚åœ¨æˆ‘ä»¬ç›®å‰çš„ä»£ç ä¸­ï¼Œä¸€æ—¦ RabbitMQ å‘é€äº†ä¸€ä¸ªæ¶ˆæ¯ç»™æ¶ˆè´¹è€…ï¼Œå®ƒå°±ç«‹å³å°†è¿™ä¸ªæ¶ˆæ¯æ ‡è®°ä¸ºåˆ é™¤ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœç»ˆæ­¢ç›¸åº”çš„å·¥ä½œè€…çš„è¯ï¼Œæˆ‘ä»¬å°†ä¸¢å¤±å®ƒæ­£åœ¨å¤„ç†çš„é‚£æ¡æ¶ˆæ¯ï¼ŒåŒæ—¶ï¼Œæˆ‘ä»¬è¿˜ä¼šä¸¢å¤±æ‰€æœ‰åˆ†å‘ç»™è¿™ä¸ªå·¥ä½œè€…çš„å°šæœªå¤„ç†çš„æ¶ˆæ¯ã€‚</p>
<p>å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬ä¸æƒ³ä¸¢å¤±ä»»ä½•ä»»åŠ¡ï¼Œå¦‚æœä¸€ä¸ªå·¥ä½œè€…è¢«ç»ˆæ­¢ï¼Œæˆ‘ä»¬å¸Œæœ›ä»»åŠ¡å°†è¢«åˆ†å‘åˆ°å¦ä¸€ä¸ªå·¥ä½œè€…ã€‚</p>
<p>ä¸ºäº†ç¡®ä¿ä¸€æ¡æ¶ˆæ¯æ°¸ä¸ä¸¢å¤±ï¼ŒRabbitMQ æ”¯æŒ<a href="https://www.rabbitmq.com/confirms.html">æ¶ˆæ¯ç¡®è®¤</a>ã€‚ä¸€ä¸ª ackï¼ˆnowledgement) æ˜¯ç”±æ¥æ”¶ã€å¤„ç†ç‰¹å®šæ¶ˆæ¯åæ¶ˆè´¹è€…è¿”å›ç»™ RabbitMQ çš„ï¼Œå‘Šè¯‰ RabbitMQ å¯ä»¥åˆ é™¤ç›¸åº”çš„æ¶ˆæ¯ã€‚</p>
<p>å¦‚æœæ¶ˆè´¹è€…æœªè¿”å›ä¸€ä¸ª ack è€Œè¢«ç»ˆæ­¢ï¼ˆå®ƒçš„ä¿¡é“å…³é—­ï¼Œè¿æ¥å…³é—­æˆ–è€… TCP è¿æ¥ä¸¢å¤±ï¼‰ï¼ŒRabbitMQ çŸ¥é“ç›¸å…³çš„æ¶ˆæ¯æ²¡æœ‰è¢«å®Œæ•´çš„å¤„ç†å¹¶é‡æ–°å°†å…¶æ”¾å…¥é˜Ÿåˆ—ã€‚å¦‚æœæ­¤æ—¶æœ‰å…¶å®ƒçš„æ¶ˆè´¹è€…è¿æ¥åˆ°é˜Ÿåˆ—ä¸Šï¼ŒRabbitMQ å°†å¿«é€Ÿçš„å°†æ¶ˆæ¯é‡æ–°åˆ†å‘åˆ°å¦ä¸€ä¸ªæ¶ˆè´¹è€…ã€‚è¿™æ ·ï¼Œå°±ç®—æœ‰å·¥ä½œè€…æ„å¤–ç»ˆæ­¢ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿è¯æ²¡æœ‰æ¶ˆæ¯ä¸¢å¤±ã€‚</p>
<p>ç›®å‰è¿˜æ²¡æœ‰è€ƒè™‘æ¶ˆæ¯è¶…æ—¶ã€‚RabbitMQ ä¼šåœ¨å½“æ¶ˆè´¹è€…æ„å‘³ç»ˆæ­¢æ˜¯é‡æ–°åˆ†å‘æ¶ˆæ¯ï¼Œç”šè‡³å¤„ç†ä¸€ä¸ªèŠ±è´¹å¾ˆé•¿æ—¶é—´çš„æ¶ˆæ¯ä¹Ÿè¿˜ç®— OKã€‚</p>
<p>æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡è®¾ç½® <code>auto-ack</code> å‚æ•°çš„å€¼ä¸º <code>false</code> æ¥è®©å·¥ä½œè€…æ‰‹åŠ¨è¿”å›æ¶ˆæ¯ç¡®è®¤ï¼Œç„¶åå·¥ä½œè€…åœ¨å¤„ç†å®Œä»»åŠ¡æ—¶é€šè¿‡ <code>d.Ack(false)</code>ï¼ˆè¿™ä¸ªç¡®è®¤åªé’ˆå¯¹äºå•ä¸ªåˆ†å‘ï¼‰å°†è¿”å›ä¸€ä¸ªæ­£ç¡®çš„ç¡®è®¤ã€‚</p>
<pre><code class="language-go">msgs, err := ch.Consume(
  q.Name, // queue
  &quot;&quot;,     // consumer
  false,  // auto-ack
  false,  // exclusive
  false,  // no-local
  false,  // no-wait
  nil,    // args
)
failOnError(err, &quot;Failed to register a consumer&quot;)

forever := make(chan bool)

go func() {
  for d := range msgs {
    log.Printf(&quot;Received a message: %s&quot;, d.Body)
    dot_count := bytes.Count(d.Body, []byte(&quot;.&quot;))
    t := time.Duration(dot_count)
    time.Sleep(t * time.Second)
    log.Printf(&quot;Done&quot;)
    d.Ack(false)
  }
}()

log.Printf(&quot; [*] Waiting for messages. To exit press CTRL+C&quot;)
&lt;-forever
</code></pre>
<p>ä½¿ç”¨ä¸Šé¢çš„ä»£ç ï¼Œå°±ç®—é€šè¿‡ <code>CTRL+C</code> ç»ˆæ­¢ä¸€ä¸ªæ­£åœ¨å¤„ç†æ¶ˆæ¯çš„å·¥ä½œè€…ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿è¯æ²¡æœ‰æ¶ˆæ¯ä¸¢å¤±ï¼Œä¸€æ—¦å·¥ä½œè€…è¢«ç»ˆæ­¢ï¼Œæ‰€æœ‰çš„å°šæœªç¡®è®¤çš„æ¶ˆæ¯ä¼šè¢«é‡æ–°åˆ†å‘ã€‚</p>
<p>ç¡®è®¤å¿…é¡»é€šè¿‡ä½¿ç”¨åˆ†å‘æ¶ˆæ¯çš„åŒä¸€ä¸ªä¿¡é“æ¥è¿”å›ï¼Œè¯•å›¾ä½¿ç”¨ä¸åŒçš„ä¿¡é“æ¥è¿”å›ç¡®è®¤ä¼šå¯¼è‡´ä¿¡é“çº§åˆ«çš„åè®®å¼‚å¸¸ï¼Œè®¿é—® <a href="https://www.rabbitmq.com/confirms.html">doc guide on confirmations </a> äº†è§£æ›´å¤šã€‚</p>
<blockquote>
<p>Note:</p>
<p><strong>å¿˜è®°ç¡®è®¤</strong></p>
<p>å¿˜è®° <code>ack</code> æ˜¯å¾ˆå¸¸è§çš„é”™è¯¯ï¼ŒçŠ¯é”™å¾ˆç®€å•ï¼Œä½†åæœå¾ˆä¸¥é‡ã€‚å½“å®¢æˆ·ç«¯ç»ˆæ­¢æ—¶ï¼Œæ¶ˆæ¯å°†è¢«ï¼ˆéšæœºåœ°ï¼‰é‡æ–°åˆ†å‘ï¼Œä½† RabbitMQ å°†å› ä¸ºæ²¡æœ‰é‡Šæ”¾æœªåº”ç­”çš„æ¶ˆæ¯åƒæ‰è¶Šæ¥è¶Šå¤šçš„å†…å­˜ã€‚</p>
<p>ä¸ºäº†èƒ½å¤Ÿè°ƒè¯•è¿™ç±»é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨ <code>rabbitmqctl</code> æ¥æ‰“å° <code>messages_unacknowledged</code> å­—æ®µï¼š</p>
<pre><code class="language-sh">sudo rabbitmqctl list_queues name messages_ready messages_unacknowledged
</code></pre>
<p>åœ¨ Windows ä¸Šï¼š</p>
<pre><code class="language-sh">rabbitmqctl.bat list_queues name messages_ready messages_unacknowledge
</code></pre>
</blockquote>
<h2 id="æ¶ˆæ¯æŒä¹…åŒ–">æ¶ˆæ¯æŒä¹…åŒ–</h2>
<p>æˆ‘ä»¬å·²ç»æŒæ¡äº†å½“æ¶ˆè´¹è€…ç»ˆæ­¢æ—¶æ€æ ·ç¡®ä¿ä»»åŠ¡ä¸ä¼šä¸¢å¤±ï¼Œä½†å½“ RabbitMQ æœåŠ¡åœæ­¢æ—¶ï¼Œä»»åŠ¡è¿˜æ˜¯ä¼šä¸¢å¤±ã€‚</p>
<p>å½“ RabbitMQ å…³é—­æˆ–å´©æºƒæ—¶ï¼Œå®ƒå°†ä¸¢å¤±æ‰€æœ‰çš„é˜Ÿåˆ—å’Œæ¶ˆæ¯ï¼Œé™¤éä½ è®¾ç½®å®ƒä¸è¿™æ ·ã€‚ä¸ºäº†ç¡®ä¿æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œéœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼šæˆ‘ä»¬éœ€è¦æ ‡è®°é˜Ÿåˆ—å’Œæ¶ˆæ¯æ—¶æŒä¹…åŒ–çš„ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ RabbitMQ æ°¸è¿œä¸ä¼šä¸¢å¤±é˜Ÿåˆ—ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å…¶ä¸º <code>durable</code>ï¼š</p>
<pre><code class="language-golang">q, err := ch.QueueDeclare(
  &quot;hello&quot;,      // name
  true,         // durable
  false,        // delete when unused
  false,        // exclusive
  false,        // no-wait
  nil,          // arguments
)
failOnError(err, &quot;Failed to declare a queue&quot;)
</code></pre>
<p>å°½ç®¡ä¸Šé¢çš„ä»£ç æ­£ç¡®æ— è¯¯ï¼Œä½†å®ƒä¸ä¼šæŒ‰ç…§æˆ‘ä»¬çš„æœŸæœ›å·¥ä½œã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å·²ç»å£°æ˜äº†ä¸€ä¸ªä¸æ˜¯æŒä¹…åŒ–çš„åä¸º <code>hello</code> çš„é˜Ÿåˆ—äº†ï¼ŒRabbitMQ ä¸å…è®¸é‡æ–°å£°æ˜ä¸€ä¸ªå¸¦æœ‰ä¸åŒå‚æ•°çš„åŒåé˜Ÿåˆ—ï¼Œå¦‚æœå°è¯•è¿™æ ·å£°æ˜ï¼Œç¨‹åºå°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡å£°æ˜ä¸€ä¸ªä¸åŒåå­—çš„é˜Ÿåˆ—æ¥å¿«é€Ÿè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚ <code>task_queue</code>ï¼š</p>
<pre><code class="language-golang">q, err := ch.QueueDeclare(
  &quot;task_queue&quot;, // name
  true,         // durable
  false,        // delete when unused
  false,        // exclusive
  false,        // no-wait
  nil,          // arguments
)
failOnError(err, &quot;Failed to declare a queue&quot;)
</code></pre>
<p>è¿™é‡Œçš„ <code>durable</code> é€‰é¡¹éœ€è¦åœ¨ç”Ÿæˆè€…å’Œæ¶ˆè´¹è€…ä»£ç ä¸­åŒæ—¶åº”ç”¨ã€‚</p>
<p>è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬ç¡®ä¿äº†å°±ç®— RabbitMQ é‡å¯ <code>task_queue</code> é˜Ÿåˆ—ä¹Ÿä¸ä¼šæ¶ˆå¤±ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è®¾ç½® <code>amqp.Publishing</code> ä¸­çš„ <code>amqp.Persistent</code> é€‰é¡¹å°†æ¶ˆæ¯æ ‡è®°ä¸ºæŒä¹…åŒ–çš„ã€‚</p>
<pre><code class="language-go">err = ch.Publish(
  &quot;&quot;,           // exchange
  q.Name,       // routing key
  false,        // mandatory
  false,
  amqp.Publishing {
    DeliveryMode: amqp.Persistent,
    ContentType:  &quot;text/plain&quot;,
    Body:         []byte(body),
})
</code></pre>
<blockquote>
<p>Note:</p>
<p><strong>æ¶ˆæ¯æŒä¹…åŒ–</strong></p>
</blockquote>
<blockquote>
<p>å°†æ¶ˆæ¯æ ‡è®°ä¸ºæŒä¹…åŒ–å¹¶ä¸èƒ½å®Œå…¨ä¿è¯æ¶ˆå¤±ä¸ä¼šä¸¢å¤±ã€‚å°½ç®¡è¿™æ ·è®¾ç½®å·²ç»å‘ŠçŸ¥ RabbitMQ å°†æ¶ˆæ¯ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼Œä½†ä»æœ‰å½“ RabbitMQ æ¥æ”¶äº†æ¶ˆæ¯ä½†æ²¡æœ‰å°†å…¶ä¿å­˜åˆ°ç£ç›˜çš„æ—¶é—´çª—å£ï¼Œå¹¶ä¸” RabbitMQ å¹¶ä¸ä¼šå¯¹æ‰€æœ‰çš„æ¶ˆæ¯æ‰§è¡Œ <code>fsync(2)</code> å‡½æ•° -- è¿™æ ·æœ‰å¯èƒ½å¯¼è‡´æ¶ˆæ¯åªä¿å­˜åˆ°äº†ç¼“å­˜ä¸­è€Œæ²¡æœ‰çœŸæ­£å†™å…¥ç£ç›˜ã€‚æŒä¹…åŒ–å¹¶æœªå¾—åˆ°å¼ºä¿è¯ï¼Œä½†æ˜¯å¯¹äºç®€å•çš„ä»»åŠ¡é˜Ÿåˆ—å·²ç»è¶³å¤Ÿã€‚å¦‚æœéœ€è¦æŒä¹…åŒ–æ›´åŠ å¼ºçš„ä¿è¯ï¼Œå¯ä»¥ä½¿ç”¨ <a href="https://www.rabbitmq.com/confirms.html">publisher confirms</a>ã€‚</p>
</blockquote>
<h2 id="å…¬å¹³åˆ†å‘">å…¬å¹³åˆ†å‘</h2>
<p>ä½ æœ‰å¯èƒ½æ³¨æ„åˆ°ï¼Œæœ‰æ—¶æ¶ˆæ¯å¹¶æœªæŒ‰æˆ‘ä»¬æœŸæœ›çš„é‚£æ ·çš„åˆ†å‘ã€‚è®¾æƒ³è¿™æ ·ä¸€ç§æƒ…å½¢ï¼šæœ‰ä¸¤ä¸ªå·¥ä½œè€…ï¼Œå¥‡æ•°å·çš„æ¶ˆæ¯å¾ˆé‡é‡è€Œå¶æ•°å·çš„æ¶ˆæ¯å¾ˆè½»é‡ï¼Œä¸€ä¸ªå·¥ä½œè€…ä¼šä¸€ç›´å¤„äºç¹å¿™çŠ¶æ€è€Œå¦ä¸€ä¸ªå‡ ä¹æ²¡æœ‰ä»€ä¹ˆå·¥ä½œã€‚RabbitMQ ä¸ä¼šçŸ¥æ™“å¹¶ä»æ—§å¹³ç­‰åœ°åˆ†å‘æ¶ˆæ¯ã€‚</p>
<p>å¯¼è‡´è¿™ç§æƒ…å†µæ˜¯å› ä¸º RabbitMQ å½“æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—æ—¶ä»…ä»…åˆ†å‘æ¶ˆæ¯ï¼Œå®ƒä¸ä¼šè€ƒè™‘æ¶ˆè´¹è€…çš„æœªç¡®è®¤æ¶ˆæ¯çš„ä¸ªæ•°ï¼Œå®ƒåªæ˜¯ç›²ç›®åœ°å°†ç¬¬ n å·æ¶ˆæ¯å‘é€ç»™ç¬¬ n å· æ¶ˆè´¹è€…ã€‚</p>
<figure data-type="image" tabindex="1"><img src="http://img-haotrr.test.upcdn.net/blog/2-1-prefetch-count.png" alt="2-1-prefetch-count" loading="lazy"></figure>
<p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å°†é¢„å–æ•°è®¾ç½®ä¸º 1ï¼Œè¿™æ ·æˆ‘ä»¬å‘Šè¯‰ RabbitMQ ä¸è¦åŒæ—¶åˆ†å‘ç»™ä¸€ä¸ªå·¥ä½œè€…è¶…è¿‡ 1 çš„æ¶ˆæ¯ã€‚æˆ–è€…è¯´ï¼Œåœ¨å·¥ä½œè€…æ²¡æœ‰å¤„ç†å®Œä»»ä½•å¹¶è¿”å›ç¡®è®¤æ—¶ä¸è¦ç»™å®ƒåˆ†å‘æ–°çš„æ¶ˆæ¯ï¼Œè¿™æ · RabbitMQ å°†ä¿¡æ¯åˆ†å‘ç»™äº†ä¸¤å¤–é‚£ä¸ªä¸å¿™çš„å·¥ä½œè€…ã€‚</p>
<pre><code class="language-go">err = ch.Qos(
  1,     // prefetch count
  0,     // prefetch size
  false, // global
)
failOnError(err, &quot;Failed to set QoS&quot;)
</code></pre>
<blockquote>
<p>Note:</p>
<p><strong>é˜Ÿåˆ—å®¹é‡</strong></p>
<p>å½“æ‰€æœ‰çš„å·¥ä½œè€…éƒ½å¤„äºç¹å¿™çŠ¶æ€ï¼Œé˜Ÿåˆ—æœ‰å¯èƒ½ä¼šè¢«å¡«æ»¡ï¼Œè¿™ä¸€ç‚¹éœ€è¦å¼•èµ·æ³¨æ„ï¼Œå¯ä»¥é€šè¿‡å¢åŠ æ›´å¤šçš„å·¥ä½œè€…æˆ–å…¶å®ƒæ–¹æ³•è§£å†³ã€‚</p>
</blockquote>
<h2 id="æ•´ä½“æ¥çœ‹">æ•´ä½“æ¥çœ‹</h2>
<p>æœ€ç»ˆçš„ <code>new_task.go</code> ä»£ç ï¼š</p>
<pre><code class="language-go">package main

import (
        &quot;fmt&quot;
        &quot;log&quot;
        &quot;os&quot;
        &quot;strings&quot;

        &quot;github.com/streadway/amqp&quot;
)

func failOnError(err error, msg string) {
        if err != nil {
                log.Fatalf(&quot;%s: %s&quot;, msg, err)
                panic(fmt.Sprintf(&quot;%s: %s&quot;, msg, err))
        }
}

func main() {
        conn, err := amqp.Dial(&quot;amqp://guest:guest@localhost:5672/&quot;)
        failOnError(err, &quot;Failed to connect to RabbitMQ&quot;)
        defer conn.Close()

        ch, err := conn.Channel()
        failOnError(err, &quot;Failed to open a channel&quot;)
        defer ch.Close()

        q, err := ch.QueueDeclare(
                &quot;task_queue&quot;, // name
                true,         // durable
                false,        // delete when unused
                false,        // exclusive
                false,        // no-wait
                nil,          // arguments
        )
        failOnError(err, &quot;Failed to declare a queue&quot;)

        body := bodyFrom(os.Args)
        err = ch.Publish(
                &quot;&quot;,           // exchange
                q.Name,       // routing key
                false,        // mandatory
                false,
                amqp.Publishing{
                        DeliveryMode: amqp.Persistent,
                        ContentType:  &quot;text/plain&quot;,
                        Body:         []byte(body),
                })
        failOnError(err, &quot;Failed to publish a message&quot;)
        log.Printf(&quot; [x] Sent %s&quot;, body)
}

func bodyFrom(args []string) string {
        var s string
        if (len(args) &lt; 2) || os.Args[1] == &quot;&quot; {
                s = &quot;hello&quot;
        } else {
                s = strings.Join(args[1:], &quot; &quot;)
        }
        return s
}
</code></pre>
<p><a href="http://github.com/rabbitmq/rabbitmq-tutorials/blob/master/go/new_task.go">new_task.go</a></p>
<p><code>worker.go</code> ä»£ç ï¼š</p>
<pre><code class="language-go">package main

import (
        &quot;bytes&quot;
        &quot;fmt&quot;
        &quot;github.com/streadway/amqp&quot;
        &quot;log&quot;
        &quot;time&quot;
)

func failOnError(err error, msg string) {
        if err != nil {
                log.Fatalf(&quot;%s: %s&quot;, msg, err)
                panic(fmt.Sprintf(&quot;%s: %s&quot;, msg, err))
        }
}

func main() {
        conn, err := amqp.Dial(&quot;amqp://guest:guest@localhost:5672/&quot;)
        failOnError(err, &quot;Failed to connect to RabbitMQ&quot;)
        defer conn.Close()

        ch, err := conn.Channel()
        failOnError(err, &quot;Failed to open a channel&quot;)
        defer ch.Close()

        q, err := ch.QueueDeclare(
                &quot;task_queue&quot;, // name
                true,         // durable
                false,        // delete when unused
                false,        // exclusive
                false,        // no-wait
                nil,          // arguments
        )
        failOnError(err, &quot;Failed to declare a queue&quot;)

        err = ch.Qos(
                1,     // prefetch count
                0,     // prefetch size
                false, // global
        )
        failOnError(err, &quot;Failed to set QoS&quot;)

        msgs, err := ch.Consume(
                q.Name, // queue
                &quot;&quot;,     // consumer
                false,  // auto-ack
                false,  // exclusive
                false,  // no-local
                false,  // no-wait
                nil,    // args
        )
        failOnError(err, &quot;Failed to register a consumer&quot;)

        forever := make(chan bool)

        go func() {
                for d := range msgs {
                        log.Printf(&quot;Received a message: %s&quot;, d.Body)
                        dot_count := bytes.Count(d.Body, []byte(&quot;.&quot;))
                        t := time.Duration(dot_count)
                        time.Sleep(t * time.Second)
                        log.Printf(&quot;Done&quot;)
                        d.Ack(false)
                }
        }()

        log.Printf(&quot; [*] Waiting for messages. To exit press CTRL+C&quot;)
        &lt;-forever
}
</code></pre>
<p><a href="https://github.com/rabbitmq/rabbitmq-tutorials/blob/master/go/worker.go">worker.go</a></p>
<p>é€šè¿‡æ¶ˆæ¯ç¡®è®¤å’Œè®¾ç½®é¢„å–æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼Œè€ŒæŒä¹…åŒ–é€‰é¡¹å¯ä»¥åœ¨ RabbitMQ é‡å¯çš„æƒ…å†µä¸‹ä¿å­˜æˆ‘ä»¬çš„ä»»åŠ¡ã€‚</p>
<p>æ›´å¤šå…³äº <code>amqp.Channel</code> æ–¹æ³•å’Œæ¶ˆæ¯çš„å±æ€§ï¼Œè¯·å‚è€ƒ <a href="http://godoc.org/github.com/streadway/amqp">amqp API reference</a>ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œè¯·ç§»æ­¥è‡³ <a href="/post/rabbitmq-tutorial-go-3/">æ•™ç¨‹ä¸‰</a> æ¥æŒæ¡æ€æ ·å°†åŒä¸€æ¶ˆæ¯å‘é€ç»™å¾ˆå¤šæ¶ˆè´¹è€…ã€‚</p>

                          </div>
                        </div>
                        <div class="layout-post-social">
                          <div class="item reader">
                            <div id="/post/rabbitmq-tutorial-go-2/" class="leancloud-visitors view"
                              data-flag-title="RabbitMQ å…¥é—¨æ•™ç¨‹ï¼ˆäºŒï¼‰- å·¥ä½œé˜Ÿåˆ—">
                              <span class="post-meta-item-text">é˜…è¯» </span>
                              <span class="leancloud-visitors-count"></span>
                            </div>
                          </div>
                        </div>

                        <div class="layout-post-navigation">
                          <div class="navigation-list">
                            
                            <div class="post-card row">
                              
                              <div class="card-content col-8 col-md-9">
                                <div class="card-body">
                                  <div class="header">
                                    <a href="https://haottr.github.io/post/rabbitmq-tutorial-go-3/" class="title">
                                      <h4>RabbitMQ å…¥é—¨æ•™ç¨‹ï¼ˆä¸‰ï¼‰- å‘å¸ƒè®¢é˜…</h4>
                                    </a>
                                  </div>
                                  <div class="inner d-none d-sm-block">
                                    <div class="abstract">
                                      <p>æœ¬ç³»åˆ—æ˜¯ RabbitMQ å®˜æ–¹æ•™ç¨‹ Go ç‰ˆæœ¬çš„ä¸­è¯‘ç‰ˆæœ¬ï¼Œæœ¬æ–‡ä¸ºç¬¬ä¸‰ç¯‡ï¼Œä»‹ç» RabbitMQ çš„å‘å¸ƒè®¢é˜…æ¨¡å¼ã€‚</p>

                                    </div>
                                  </div>
                                </div>
                                <div class="card-footer">
                                  <div class="item"><span>ä¸Šä¸€ç¯‡</span></div>
                                  <div class="item">2018-09-29</div>
                                </div>
                              </div>
                              <div class="card-thumb col-4 col-md-3">
                                <div class="thumb">
                                  <a href="https://haottr.github.io/post/rabbitmq-tutorial-go-3/"
                                    style="background-image: url('http://img-haotrr.test.upcdn.net/blog/Greece3.jpg');"></a>
                                </div>
                              </div>
                              
                            </div>

                            <div class="post-card row">
                              
                              <div class="card-content col-8 col-md-9">
                                <div class="card-body">
                                  <div class="header">
                                    <a href="https://haottr.github.io/post/rabbitmq-tutorial-go-1/" class="title">
                                      <h4>RabbitMQ å…¥é—¨æ•™ç¨‹ï¼ˆä¸€ï¼‰- &#34;Hello World!&#34;</h4>
                                    </a>
                                  </div>
                                  <div class="inner d-none d-sm-block">
                                    <div class="abstract">
                                      <p>æœ¬ç³»åˆ—æ˜¯ RabbitMQ å®˜æ–¹æ•™ç¨‹ Go ç‰ˆæœ¬çš„ä¸­è¯‘ç‰ˆæœ¬ï¼Œæœ¬æ–‡ä¸ºç¬¬ä¸€ç¯‡ï¼Œç®€å•ä»‹ç» RabbitMQ æœ€åŸºæœ¬çš„ç”Ÿäº§-æ¶ˆè´¹è€…æ¨¡å¼ã€‚</p>

                                    </div>
                                  </div>
                                </div>
                                <div class="card-footer">
                                  <div class="item"><span>ä¸‹ä¸€ç¯‡</span></div>
                                  <div class="item">2018-09-29</div>
                                </div>
                              </div>
                              <div class="card-thumb col-4 col-md-3">
                                <div class="thumb">
                                  <a href="https://haottr.github.io/post/rabbitmq-tutorial-go-1/"
                                    style="background-image: url('http://img-haotrr.test.upcdn.net/blog/Greece1.png');"></a>
                                </div>
                              </div>
                              
                            </div>

                            
                          </div>
                        </div>

                        <div class="layout-comments"></div>
                        
                        <script type="text/javascript" src='https://haottr.github.io/media/scripts/zan.js'></script>
<script type="text/javascript" src='https://haottr.github.io/media/scripts/av-min.js'></script>
<script type="text/javascript" src='https://haottr.github.io/media/scripts/Valine.min.js'></script>

<script>
  var valine = new Valine();
  valine.init({
    el: '.layout-comments',
    appId: 'kyaFrbniElwRf2iVD1a5ts2y-gzGzoHsz',
    appKey: 'Vjt2F1yKTk5BgEWtCPO4FukL',
    notify: false,
    verify: false,
    visitor: true,
    avatar: 'mp',
    placeholder: 'åŠ å…¥è®¨è®º...'
  })
</script>
                        
                      </div>
                    </div>

                    <div class="col-12 col-lg-3 d-none d-lg-block">
                      <div class="layout-post-sidebar">
                        <div class="layout-sidebar-item">
                          <ul class="markdownIt-TOC">
<li>
<ul>
<li><a href="#%E5%87%86%E5%A4%87">å‡†å¤‡</a></li>
<li><a href="#%E8%BD%AE%E8%AF%A2%E5%88%86%E5%8F%91">è½®è¯¢åˆ†å‘</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E7%A1%AE%E8%AE%A4">æ¶ˆæ¯ç¡®è®¤</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96">æ¶ˆæ¯æŒä¹…åŒ–</a></li>
<li><a href="#%E5%85%AC%E5%B9%B3%E5%88%86%E5%8F%91">å…¬å¹³åˆ†å‘</a></li>
<li><a href="#%E6%95%B4%E4%BD%93%E6%9D%A5%E7%9C%8B">æ•´ä½“æ¥çœ‹</a></li>
</ul>
</li>
</ul>

                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="layout-totop d-none"><i class="fa fa-angle-up" aria-hidden="true"></i></div>

    <div class="layout-footer">

	<div class="container">
		<div class="row justify-content-lg-center">
			<div class="col-12 col-lg-9">
				<div class="footer">
					<div class="row">
						<div class="col-12 col-md-9">
							<div class="footer-copy">
								
								Â© 2015-2020 Haotrr<span class="px-2">â‹…</span>Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> & Theme <a href="https://github.com/insdram/gridea-theme-vant">Vant</a> & Pics <a href="https://www.upyun.com/">UpYun</a>
								<div class="footer-icp d-none d-sm-inline-block">
									<span class="px-2">â‹…</span>
									
								</div>
							</div>
						</div>
						<div class="col-sm-3 d-none d-md-block">
							<div class="footer-links">
								
								
								<span class="px-2">â‹…</span>
								<span class="footer-links-item">
									<a href="https://twitter.com/haotrr" target="_blank">
										<i class="fa fa-twitter" aria-hidden="true"></i>
									</a>
								</span>
								
								
								
								<span class="px-2">â‹…</span>
								<span class="footer-links-item">
									<a href="https://github.com/haotrr" target="_blank">
										<i class="fa fa-github" aria-hidden="true"></i>
									</a>
								</span>
								
								
								
								
								
								
								
								
								
								
								
								
								
								
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

</div>

<script type="text/javascript" src='https://haottr.github.io/media/scripts/main.js'></script>


  </div>
</body>
<!-- æ›´è¿›ä¸€æ­¥çš„æ‹¿æ¥ä¸»ä¹‰ï¼Œè¿™æ®µä»£ç åŠä¸€å®šçš„ CSS æ ·å¼æ‹·è´è‡ª Gridea çš„ Next ä¸»é¢˜ï¼šhttps://github.com/hsxyhao/gridea-theme-nextï¼ŒğŸ˜º -->
<script>
  // æ‹¿æ¥ä¸»ä¹‰(çœŸé¦™)^_^ï¼ŒClipboard å®ç°æ‘˜è‡ªæ˜é‡‘ https://juejin.im/post/5aefeb6e6fb9a07aa43c20af
  window.Clipboard = (function (window, document, navigator) {
    var textArea,
      copy;

    // åˆ¤æ–­æ˜¯ä¸æ˜¯iosç«¯
    function isOS() {
      return navigator.userAgent.match(/ipad|iphone/i);
    }
    // åˆ›å»ºæ–‡æœ¬å…ƒç´ 
    function createTextArea(text) {
      textArea = document.createElement('textArea');
      textArea.value = text;
      textArea.style.width = 0;
      textArea.style.height = 0;
      textArea.clientHeight = 0;
      textArea.clientWidth = 0;
      document.body.appendChild(textArea);
    }
    // é€‰æ‹©å†…å®¹
    function selectText() {
      var range,
        selection;

      if (isOS()) {
        range = document.createRange();
        range.selectNodeContents(textArea);
        selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        textArea.setSelectionRange(0, 999999);
      } else {
        textArea.select();
      }
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard() {
      try {
        document.execCommand("Copy")
      } catch (err) {
        alert("å¤åˆ¶é”™è¯¯ï¼è¯·æ‰‹åŠ¨å¤åˆ¶ï¼")
      }
      document.body.removeChild(textArea);
    }

    copy = function (text) {
      createTextArea(text);
      selectText();
      copyToClipboard();
    };

    return {
      copy: copy
    };
  })(window, document, navigator);

  function copyCode(e) {
    if (e.srcElement.tagName === 'SPAN' && e.srcElement.classList.contains('copy-code')) {
      let code = e.currentTarget.querySelector('code');
      var text = code.innerText;
      if (e.srcElement.textContent === 'å¤åˆ¶æˆåŠŸ') {
        console.log('å¤åˆ¶æ“ä½œé¢‘ç‡è¿‡é«˜');
        return;
      }
      e.srcElement.textContent = 'å¤åˆ¶æˆåŠŸ';
      (function (elem) {
        setTimeout(() => {
          if (elem.textContent === 'å¤åˆ¶æˆåŠŸ') {
            elem.textContent = 'å¤åˆ¶ä»£ç '
          }
        }, 1000);
      })(e.srcElement)
      Clipboard.copy(text);
    }
  }

  let pres = document.querySelectorAll('pre');
  pres.forEach(pre => {
    let code = pre.querySelector('code');
    let copyElem = document.createElement('span');
    copyElem.classList.add('copy-code');
    copyElem.textContent = 'å¤åˆ¶ä»£ç ';
    pre.appendChild(copyElem);
    pre.onclick = copyCode
  })
</script>

</html>